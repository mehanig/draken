name: Deploy Website to R2

on:
  push:
    branches: [ "master", "main" ]
    paths:
      - 'site/**'
  workflow_dispatch:

env:
  BUILD_PATH: build-${{ github.run_number }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          aws s3 sync site s3://draken-site/${{ env.BUILD_PATH }} \
            --endpoint-url https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com \
            --region auto

      - name: Update Cloudflare Transform Rules
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          # Update Transform Rules to point to new build
          # Get existing rules for other subdomains, then add draken rules
          # Note: This replaces ALL transform rules in the zone - existing rules for other subdomains
          # should be managed separately or included here
          curl -X PUT "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/rulesets/phases/http_request_transform/entrypoint" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{
              "rules": [
                {
                  "expression": "(http.host eq \"draken.mehanig.com\" and starts_with(http.request.uri.path, \"/img/\"))",
                  "description": "Draken: Serve Images",
                  "action": "rewrite",
                  "action_parameters": {
                    "uri": {
                      "path": {
                        "expression": "concat(\"/${{ env.BUILD_PATH }}\", http.request.uri.path)"
                      }
                    }
                  }
                },
                {
                  "expression": "(http.host eq \"draken.mehanig.com\" and (ends_with(http.request.uri.path, \".png\") or ends_with(http.request.uri.path, \".svg\") or ends_with(http.request.uri.path, \".ico\") or ends_with(http.request.uri.path, \".jpg\") or ends_with(http.request.uri.path, \".jpeg\") or ends_with(http.request.uri.path, \".gif\") or ends_with(http.request.uri.path, \".webp\") or ends_with(http.request.uri.path, \".css\") or ends_with(http.request.uri.path, \".js\")))",
                  "description": "Draken: Serve Static Files",
                  "action": "rewrite",
                  "action_parameters": {
                    "uri": {
                      "path": {
                        "expression": "concat(\"/${{ env.BUILD_PATH }}\", http.request.uri.path)"
                      }
                    }
                  }
                },
                {
                  "expression": "(http.host eq \"draken.mehanig.com\" and not starts_with(http.request.uri.path, \"/img/\") and not ends_with(http.request.uri.path, \".png\") and not ends_with(http.request.uri.path, \".svg\") and not ends_with(http.request.uri.path, \".ico\") and not ends_with(http.request.uri.path, \".jpg\") and not ends_with(http.request.uri.path, \".jpeg\") and not ends_with(http.request.uri.path, \".gif\") and not ends_with(http.request.uri.path, \".webp\") and not ends_with(http.request.uri.path, \".css\") and not ends_with(http.request.uri.path, \".js\"))",
                  "description": "Draken: Serve index.html for all other routes",
                  "action": "rewrite",
                  "action_parameters": {
                    "uri": {
                      "path": {
                        "value": "/${{ env.BUILD_PATH }}/index.html"
                      }
                    }
                  }
                }
              ]
            }'

      - name: Print deployment info
        run: |
          echo "✅ Deployed to: draken-site/${{ env.BUILD_PATH }}/"
          echo "✅ Transform rules updated to point to ${{ env.BUILD_PATH }}"
